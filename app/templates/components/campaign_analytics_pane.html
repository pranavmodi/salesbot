<!-- Campaign Analytics Pane with Click Tracking -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-chart-line me-2"></i>Campaign Analytics
        </h5>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm btn-outline-primary active" onclick="showAnalyticsOverview()">
                <i class="fas fa-chart-pie me-1"></i>Overview
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="showClickDetails()">
                <i class="fas fa-mouse-pointer me-1"></i>Click Details
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="showPerformanceMetrics()">
                <i class="fas fa-tachometer-alt me-1"></i>Performance
            </button>
        </div>
    </div>
    <div class="card-body">
        <!-- Loading State -->
        <div id="analyticsLoading" class="text-center p-4" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading analytics...</span>
            </div>
            <p class="mt-2 text-muted">Loading campaign analytics...</p>
        </div>

        <!-- Error State -->
        <div id="analyticsError" class="alert alert-danger" style="display: none;">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="analyticsErrorMessage">Failed to load analytics data</span>
        </div>

        <!-- Analytics Overview Tab -->
        <div id="analyticsOverview" class="analytics-tab">
            <!-- Performance Metrics Row -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h4 class="mb-0" id="totalContacts">-</h4>
                                    <p class="mb-0 small">Total Contacts</p>
                                </div>
                                <i class="fas fa-users fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h4 class="mb-0" id="totalEmails">-</h4>
                                    <p class="mb-0 small">Emails Sent</p>
                                </div>
                                <i class="fas fa-envelope fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h4 class="mb-0" id="totalClicks">-</h4>
                                    <p class="mb-0 small">Report Clicks</p>
                                </div>
                                <i class="fas fa-mouse-pointer fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h4 class="mb-0" id="clickRate">-</h4>
                                    <p class="mb-0 small">Click Rate</p>
                                </div>
                                <i class="fas fa-percentage fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-chart-bar me-2"></i>Engagement Funnel
                            </h6>
                        </div>
                        <div class="card-body">
                            <canvas id="engagementFunnelChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-chart-line me-2"></i>Clicks Over Time
                            </h6>
                        </div>
                        <div class="card-body">
                            <canvas id="clicksTimeChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Engagement Details Row -->
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-building me-2"></i>Top Engaged Companies
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="topCompanies" class="list-group list-group-flush">
                                <!-- Dynamic content -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-desktop me-2"></i>Device Breakdown
                            </h6>
                        </div>
                        <div class="card-body">
                            <canvas id="deviceChart" width="300" height="300"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-globe me-2"></i>Geographic Distribution
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="geoBreakdown" class="list-group list-group-flush">
                                <!-- Dynamic content -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Click Details Tab -->
        <div id="clickDetails" class="analytics-tab" style="display: none;">
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="clickSearchInput" placeholder="Search clicks by company, email, or tracking ID...">
                    </div>
                </div>
                <div class="col-md-6">
                    <select class="form-select" id="clickDateFilter">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Timestamp</th>
                            <th>Company</th>
                            <th>Recipient</th>
                            <th>Device</th>
                            <th>Location</th>
                            <th>UTM Campaign</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clickDetailsTable">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>

            <div id="clickDetailsEmpty" class="text-center p-4" style="display: none;">
                <i class="fas fa-mouse-pointer fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No clicks recorded yet</h5>
                <p class="text-muted">Click data will appear here when prospects engage with your strategic reports.</p>
            </div>
        </div>

        <!-- Performance Metrics Tab -->
        <div id="performanceMetrics" class="analytics-tab" style="display: none;">
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-tachometer-alt me-2"></i>Campaign Performance Metrics
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="metric-item border-bottom pb-3 mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span class="text-muted">Email Delivery Rate</span>
                                            <span class="fw-bold text-success" id="deliveryRate">-</span>
                                        </div>
                                        <div class="progress mt-2" style="height: 6px;">
                                            <div class="progress-bar bg-success" id="deliveryRateBar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="metric-item border-bottom pb-3 mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span class="text-muted">Report Click Rate</span>
                                            <span class="fw-bold text-info" id="reportClickRate">-</span>
                                        </div>
                                        <div class="progress mt-2" style="height: 6px;">
                                            <div class="progress-bar bg-info" id="reportClickRateBar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="metric-item border-bottom pb-3 mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span class="text-muted">Unique Engagement Rate</span>
                                            <span class="fw-bold text-warning" id="uniqueEngagementRate">-</span>
                                        </div>
                                        <div class="progress mt-2" style="height: 6px;">
                                            <div class="progress-bar bg-warning" id="uniqueEngagementRateBar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="metric-item border-bottom pb-3 mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span class="text-muted">Companies Engaged</span>
                                            <span class="fw-bold text-primary" id="companiesEngaged">-</span>
                                        </div>
                                        <small class="text-muted">Out of <span id="totalCompaniesTargeted">-</span> targeted</small>
                                    </div>
                                    <div class="metric-item border-bottom pb-3 mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span class="text-muted">Avg. Time to Click</span>
                                            <span class="fw-bold text-secondary" id="avgTimeToClick">-</span>
                                        </div>
                                        <small class="text-muted">From email send to first click</small>
                                    </div>
                                    <div class="metric-item">
                                        <div class="d-flex justify-content-between">
                                            <span class="text-muted">Repeat Engagement</span>
                                            <span class="fw-bold text-success" id="repeatEngagement">-</span>
                                        </div>
                                        <small class="text-muted">Multiple clicks from same prospect</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-trophy me-2"></i>Campaign Score
                            </h6>
                        </div>
                        <div class="card-body text-center">
                            <div class="position-relative d-inline-block">
                                <canvas id="campaignScoreChart" width="120" height="120"></canvas>
                                <div class="position-absolute top-50 start-50 translate-middle">
                                    <h3 class="mb-0 text-primary" id="campaignScore">-</h3>
                                    <small class="text-muted">Score</small>
                                </div>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">Based on engagement metrics and industry benchmarks</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recommendations -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>Optimization Recommendations
                    </h6>
                </div>
                <div class="card-body">
                    <div id="recommendations" class="list-group list-group-flush">
                        <!-- Dynamic recommendations -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Campaign Analytics JavaScript
let currentCampaignId = null;
let analyticsData = null;
let charts = {};

function initializeCampaignAnalytics(campaignId) {
    console.log('=== ANALYTICS FRONTEND === Initializing campaign analytics for campaign:', campaignId);
    currentCampaignId = campaignId;
    loadAnalyticsData();
}

function showAnalyticsOverview() {
    $('.analytics-tab').hide();
    $('#analyticsOverview').show();
    $('.btn-group .btn').removeClass('active');
    $('.btn-group .btn').first().addClass('active');
}

function showClickDetails() {
    $('.analytics-tab').hide();
    $('#clickDetails').show();
    $('.btn-group .btn').removeClass('active');
    $('.btn-group .btn').eq(1).addClass('active');
    loadClickDetails();
}

function showPerformanceMetrics() {
    $('.analytics-tab').hide();
    $('#performanceMetrics').show();
    $('.btn-group .btn').removeClass('active');
    $('.btn-group .btn').eq(2).addClass('active');
}

function loadAnalyticsData() {
    console.log('=== ANALYTICS FRONTEND === Loading analytics data for campaign:', currentCampaignId);
    
    if (!currentCampaignId) {
        console.error('=== ANALYTICS FRONTEND === No campaign ID set!');
        return;
    }

    $('#analyticsLoading').show();
    $('#analyticsError').hide();
    
    const apiUrl = `/api/campaigns/${currentCampaignId}/analytics`;
    console.log('=== ANALYTICS FRONTEND === Making API request to:', apiUrl);

    fetch(apiUrl)
        .then(response => {
            console.log('=== ANALYTICS FRONTEND === Response status:', response.status);
            console.log('=== ANALYTICS FRONTEND === Response headers:', response.headers);
            return response.json();
        })
        .then(data => {
            console.log('=== ANALYTICS FRONTEND === Response data:', data);
            $('#analyticsLoading').hide();
            
            if (data.success) {
                console.log('=== ANALYTICS FRONTEND === Analytics data received:', data.analytics);
                analyticsData = data.analytics;
                updateAnalyticsDisplay();
            } else {
                console.error('=== ANALYTICS FRONTEND === API returned error:', data.message);
                showAnalyticsError(data.message);
            }
        })
        .catch(error => {
            console.error('=== ANALYTICS FRONTEND === Fetch error:', error);
            console.error('=== ANALYTICS FRONTEND === Error details:', error.message, error.stack);
            $('#analyticsLoading').hide();
            showAnalyticsError('Failed to load analytics data');
        });
}

function updateAnalyticsDisplay() {
    console.log('=== ANALYTICS FRONTEND === Updating analytics display');
    
    if (!analyticsData) {
        console.error('=== ANALYTICS FRONTEND === No analytics data available!');
        return;
    }

    console.log('=== ANALYTICS FRONTEND === Analytics data structure:', analyticsData);
    const metrics = analyticsData.performance_metrics;
    console.log('=== ANALYTICS FRONTEND === Performance metrics:', metrics);
    
    // Update metric cards
    $('#totalContacts').text(metrics.total_contacts.toLocaleString());
    $('#totalEmails').text(metrics.total_emails.toLocaleString());
    $('#totalClicks').text(metrics.total_clicks.toLocaleString());
    $('#clickRate').text(metrics.click_rate + '%');
    
    console.log('=== ANALYTICS FRONTEND === Updated metric cards with:', {
        contacts: metrics.total_contacts,
        emails: metrics.total_emails,
        clicks: metrics.total_clicks,
        rate: metrics.click_rate
    });

    // Update charts
    console.log('=== ANALYTICS FRONTEND === Updating charts...');
    updateEngagementFunnelChart();
    updateClicksTimeChart();
    updateDeviceChart();
    updateTopCompanies();
    updateGeographicDistribution();
    updatePerformanceMetrics();
    console.log('=== ANALYTICS FRONTEND === Charts updated successfully');
}

function updateEngagementFunnelChart() {
    const ctx = document.getElementById('engagementFunnelChart').getContext('2d');
    const metrics = analyticsData.performance_metrics;
    
    if (charts.funnelChart) {
        charts.funnelChart.destroy();
    }
    
    charts.funnelChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Contacts', 'Emails Sent', 'Reports Clicked', 'Unique Clickers'],
            datasets: [{
                label: 'Engagement Funnel',
                data: [
                    metrics.total_contacts,
                    metrics.total_emails,
                    metrics.total_clicks,
                    metrics.unique_clickers
                ],
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(255, 206, 86, 0.8)',
                    'rgba(153, 102, 255, 0.8)'
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(153, 102, 255, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function updateClicksTimeChart() {
    const ctx = document.getElementById('clicksTimeChart').getContext('2d');
    const clicksData = analyticsData.click_analytics.clicks_by_date || [];
    
    if (charts.timeChart) {
        charts.timeChart.destroy();
    }
    
    charts.timeChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: clicksData.map(d => new Date(d.date).toLocaleDateString()),
            datasets: [{
                label: 'Clicks',
                data: clicksData.map(d => d.clicks),
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function updateDeviceChart() {
    const ctx = document.getElementById('deviceChart').getContext('2d');
    
    // Mock device data - you would get this from your analytics
    const deviceData = [
        { device: 'Desktop', count: 45 },
        { device: 'Mobile', count: 35 },
        { device: 'Tablet', count: 20 }
    ];
    
    if (charts.deviceChart) {
        charts.deviceChart.destroy();
    }
    
    charts.deviceChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: deviceData.map(d => d.device),
            datasets: [{
                data: deviceData.map(d => d.count),
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(255, 206, 86, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function updateTopCompanies() {
    const container = $('#topCompanies');
    
    // Mock top companies data
    const topCompanies = [
        { name: 'Tech Corp', clicks: 12 },
        { name: 'Innovation Ltd', clicks: 8 },
        { name: 'Future Systems', clicks: 6 },
        { name: 'Digital Solutions', clicks: 4 }
    ];
    
    const html = topCompanies.map(company => `
        <div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
                <div class="fw-bold">${company.name}</div>
                <small class="text-muted">${company.clicks} clicks</small>
            </div>
            <span class="badge bg-primary rounded-pill">${company.clicks}</span>
        </div>
    `).join('');
    
    container.html(html);
}

function updateGeographicDistribution() {
    const container = $('#geoBreakdown');
    
    // Mock geographic data
    const geoData = [
        { country: 'United States', clicks: 45 },
        { country: 'Canada', clicks: 12 },
        { country: 'United Kingdom', clicks: 8 },
        { country: 'Australia', clicks: 5 }
    ];
    
    const html = geoData.map(geo => `
        <div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
                <div class="fw-bold">${geo.country}</div>
                <small class="text-muted">${geo.clicks} clicks</small>
            </div>
            <span class="badge bg-info rounded-pill">${geo.clicks}</span>
        </div>
    `).join('');
    
    container.html(html);
}

function updatePerformanceMetrics() {
    const metrics = analyticsData.performance_metrics;
    
    // Calculate performance metrics
    const deliveryRate = metrics.total_emails > 0 ? (metrics.total_emails / metrics.total_contacts * 100).toFixed(1) : 0;
    const reportClickRate = metrics.total_emails > 0 ? (metrics.total_clicks / metrics.total_emails * 100).toFixed(1) : 0;
    const uniqueEngagementRate = metrics.total_contacts > 0 ? (metrics.unique_clickers / metrics.total_contacts * 100).toFixed(1) : 0;
    
    $('#deliveryRate').text(deliveryRate + '%');
    $('#reportClickRate').text(reportClickRate + '%');
    $('#uniqueEngagementRate').text(uniqueEngagementRate + '%');
    $('#companiesEngaged').text(metrics.companies_engaged);
    $('#totalCompaniesTargeted').text(metrics.total_contacts);
    
    // Update progress bars
    $('#deliveryRateBar').css('width', deliveryRate + '%');
    $('#reportClickRateBar').css('width', reportClickRate + '%');
    $('#uniqueEngagementRateBar').css('width', uniqueEngagementRate + '%');
    
    // Calculate campaign score
    const campaignScore = Math.round((parseFloat(deliveryRate) + parseFloat(reportClickRate) + parseFloat(uniqueEngagementRate)) / 3);
    $('#campaignScore').text(campaignScore);
    
    // Update campaign score chart
    updateCampaignScoreChart(campaignScore);
}

function updateCampaignScoreChart(score) {
    const ctx = document.getElementById('campaignScoreChart').getContext('2d');
    
    if (charts.scoreChart) {
        charts.scoreChart.destroy();
    }
    
    charts.scoreChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [score, 100 - score],
                backgroundColor: [
                    score >= 70 ? 'rgba(75, 192, 192, 0.8)' : 
                    score >= 50 ? 'rgba(255, 206, 86, 0.8)' : 
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(200, 200, 200, 0.2)'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            cutout: '70%',
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function loadClickDetails() {
    if (!currentCampaignId) return;

    fetch(`/api/campaigns/${currentCampaignId}/clicks`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateClickDetailsTable(data.clicks);
            } else {
                $('#clickDetailsEmpty').show();
            }
        })
        .catch(error => {
            console.error('Click details error:', error);
            $('#clickDetailsEmpty').show();
        });
}

function updateClickDetailsTable(clicks) {
    const tbody = $('#clickDetailsTable');
    
    if (clicks.length === 0) {
        tbody.empty();
        $('#clickDetailsEmpty').show();
        return;
    }
    
    $('#clickDetailsEmpty').hide();
    
    const html = clicks.map(click => `
        <tr>
            <td>${new Date(click.click_timestamp).toLocaleString()}</td>
            <td>${click.company_name || 'Unknown'}</td>
            <td>${click.recipient_email || 'Unknown'}</td>
            <td>${click.device_type || 'Unknown'}</td>
            <td>${click.country || 'Unknown'}</td>
            <td>${click.utm_campaign || 'Unknown'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewClickDetails('${click.tracking_id}')">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        </tr>
    `).join('');
    
    tbody.html(html);
}

function viewClickDetails(trackingId) {
    // Implement click details modal
    alert(`View details for tracking ID: ${trackingId}`);
}

function showAnalyticsError(message) {
    $('#analyticsError').show();
    $('#analyticsErrorMessage').text(message);
}

// Initialize click search
$('#clickSearchInput').on('input', function() {
    const searchTerm = $(this).val().toLowerCase();
    $('#clickDetailsTable tr').each(function() {
        const text = $(this).text().toLowerCase();
        $(this).toggle(text.includes(searchTerm));
    });
});

// Initialize date filter
$('#clickDateFilter').on('change', function() {
    // Implement date filtering
    loadClickDetails();
});
</script>

<style>
.analytics-tab {
    min-height: 500px;
}

.metric-item {
    padding: 0.5rem 0;
}

.progress {
    height: 6px;
    border-radius: 3px;
}

.card-body canvas {
    max-width: 100%;
}

.opacity-50 {
    opacity: 0.5;
}

.list-group-flush .list-group-item {
    border-left: 0;
    border-right: 0;
    border-radius: 0;
}

.btn-group .btn {
    transition: all 0.3s ease;
}

.btn-group .btn.active {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
}
</style> 