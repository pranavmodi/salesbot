<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SalesBot CRM - AI-Powered Customer Engagement</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --light-bg: #f8fafc;
            --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --card-shadow-hover: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            box-shadow: var(--card-shadow);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }

        .main-content {
            padding: 2rem 0;
        }

        .nav-tabs {
            border: none;
            margin-bottom: 2rem;
        }

        .nav-tabs .nav-link {
            border: none;
            color: var(--secondary-color);
            font-weight: 500;
            padding: 1rem 2rem;
            margin-right: 0.5rem;
            border-radius: 12px 12px 0 0;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link:hover {
            background-color: #e2e8f0;
            color: var(--primary-color);
        }

        .nav-tabs .nav-link.active {
            background-color: white;
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            box-shadow: var(--card-shadow);
        }

        .card {
            border: none;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--card-shadow-hover);
            transform: translateY(-2px);
        }

        .card-header {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-bottom: 1px solid #e2e8f0;
            border-radius: 16px 16px 0 0 !important;
            padding: 1.5rem;
        }

        .contact-card {
            border-left: 4px solid var(--primary-color);
        }

        .contact-card.high-priority {
            border-left-color: var(--danger-color);
        }

        .contact-card.medium-priority {
            border-left-color: var(--warning-color);
        }

        .contact-card.low-priority {
            border-left-color: var(--success-color);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            border: none;
            border-radius: 8px;
            padding: 0.625rem 1.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 8px;
            padding: 0.625rem 1.5rem;
            font-weight: 500;
        }

        .status-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-success {
            background-color: #dcfce7;
            color: #166534;
        }

        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-failed {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .email-preview {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            white-space: pre-wrap;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.875rem;
            line-height: 1.6;
        }

        .stats-card {
            background: linear-gradient(135deg, white 0%, #f8fafc 100%);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            border-left: 4px solid var(--primary-color);
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stats-label {
            color: var(--secondary-color);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.875rem;
        }

        .search-box {
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .table {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        .table thead {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        }

        .table thead th {
            border: none;
            color: white;
            font-weight: 600;
            padding: 1rem;
        }

        .table tbody td {
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }

        .table tbody tr:hover {
            background-color: #f8fafc;
        }

        .compose-form {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
        }

        .form-control {
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .pagination .page-link {
            border: none;
            color: var(--primary-color);
            padding: 0.5rem 1rem;
            margin: 0 0.25rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .pagination .page-link:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        .pagination .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .contact-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.125rem;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-content {
            border-radius: 16px;
            border: none;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .modal-header {
            border-bottom: 1px solid #f1f5f9;
            padding: 1.5rem;
            border-radius: 16px 16px 0 0;
        }

        .modal-title {
            font-weight: 600;
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-robot me-2"></i>
                SalesBot CRM
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text text-white">
                    <i class="fas fa-user-circle me-2"></i>
                    Pranav Modi, CEO - Possible Minds
                </span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid main-content">
        <!-- Stats Overview -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalContacts">{{ total_contacts }}</div>
                    <div class="stats-label">Total Contacts</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card">
                    <div class="stats-number" id="emailsSent">{{ emails_sent }}</div>
                    <div class="stats-label">Emails Sent</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card">
                    <div class="stats-number" id="successRate">{{ success_rate }}%</div>
                    <div class="stats-label">Success Rate</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card">
                    <div class="stats-number" id="pendingContacts">{{ pending_contacts }}</div>
                    <div class="stats-label">Pending Outreach</div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="crmTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="contacts-tab" data-bs-toggle="tab" data-bs-target="#contacts" type="button" role="tab">
                    <i class="fas fa-users me-2"></i>Contacts
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="emails-tab" data-bs-toggle="tab" data-bs-target="#emails" type="button" role="tab">
                    <i class="fas fa-envelope me-2"></i>Email History
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="compose-tab" data-bs-toggle="tab" data-bs-target="#compose" type="button" role="tab">
                    <i class="fas fa-edit me-2"></i>Compose
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="crmTabContent">
            <!-- Contacts Tab -->
            <div class="tab-pane fade show active" id="contacts" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-users me-2"></i>Contact Management
                                </h5>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex justify-content-end align-items-center">
                                    <input type="text" class="form-control search-box me-3" placeholder="Search contacts..." id="contactSearch" style="max-width: 250px;">
                                    <button class="btn btn-primary" id="sendToAllBtn">
                                        <i class="fas fa-paper-plane me-2"></i>Send to All
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Pagination Controls -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <label for="perPage" class="me-2">Show:</label>
                                    <select id="perPage" class="form-select" style="width: auto;">
                                        <option value="5" {% if per_page == 5 %}selected{% endif %}>5 per page</option>
                                        <option value="10" {% if per_page == 10 %}selected{% endif %}>10 per page</option>
                                        <option value="25" {% if per_page == 25 %}selected{% endif %}>25 per page</option>
                                        <option value="50" {% if per_page == 50 %}selected{% endif %}>50 per page</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <nav aria-label="Page navigation">
                                    <ul class="pagination justify-content-end mb-0">
                                        <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                                            <a class="page-link" href="#" data-page="{{ current_page - 1 }}">
                                                <i class="fas fa-chevron-left"></i>
                                            </a>
                                        </li>
                                        <li class="page-item active">
                                            <span class="page-link">{{ current_page }} of {{ total_pages }}</span>
                                        </li>
                                        <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                                            <a class="page-link" href="#" data-page="{{ current_page + 1 }}">
                                                <i class="fas fa-chevron-right"></i>
                                            </a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>

                        <!-- Contacts Grid -->
                        <div class="row" id="contactsContainer">
                            {% for contact in contacts %}
                            <div class="col-lg-6 col-xl-4 mb-4">
                                <div class="card contact-card fade-in">
                                    <div class="card-body">
                                        <div class="d-flex align-items-start mb-3">
                                            <div class="contact-avatar me-3">
                                                {{ contact.initials }}
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="card-title mb-1">{{ contact.display_name }}</h6>
                                                <p class="text-muted mb-0 small">{{ contact.job_title or 'Position not specified' }}</p>
                                                <p class="text-primary mb-0 small fw-semibold">{{ contact.company or 'Company not specified' }}</p>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <small class="text-muted">
                                                <i class="fas fa-envelope me-1"></i>
                                                {{ contact.email or 'Email not available' }}
                                            </small><br>
                                            <small class="text-muted">
                                                <i class="fas fa-map-marker-alt me-1"></i>
                                                {{ contact.location or 'Location not specified' }}
                                            </small>
                                        </div>

                                        <div class="email-preview small" id="preview-{{ loop.index0 }}">
                                            <div class="d-flex justify-content-center">
                                                <div class="loading-spinner"></div>
                                                <span class="ms-2">Loading preview...</span>
                                            </div>
                                        </div>
                                        
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-primary send-btn" 
                                                    data-lead-index="{{ loop.index0 }}"
                                                    data-lead-name="{{ contact.first_name }}"
                                                    data-lead-email="{{ contact.email }}"
                                                    data-lead-company="{{ contact.company }}"
                                                    data-lead-position="{{ contact.job_title }}">
                                                <i class="fas fa-paper-plane me-2"></i>Send Email
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Email History Tab -->
            <div class="tab-pane fade" id="emails" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-envelope me-2"></i>Email Campaign History
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date & Time</th>
                                        <th>Recipient</th>
                                        <th>Subject</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for email in email_history %}
                                    <tr>
                                        <td>
                                            <div>{{ email.date.strftime('%Y-%m-%d') if email.date else 'N/A' }}</div>
                                            <small class="text-muted">{{ email.date.strftime('%H:%M:%S') if email.date else '' }}</small>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="contact-avatar me-2" style="width: 32px; height: 32px; font-size: 0.75rem;">
                                                    {{ email.to[:1].upper() if email.to else '?' }}
                                                </div>
                                                <div>{{ email.to }}</div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="text-truncate" style="max-width: 200px;" title="{{ email.subject }}">
                                                {{ email.subject }}
                                            </div>
                                        </td>
                                        <td>
                                            {% if email.status == 'Success' %}
                                                <span class="status-badge status-success">
                                                    <i class="fas fa-check me-1"></i>Success
                                                </span>
                                            {% else %}
                                                <span class="status-badge status-failed">
                                                    <i class="fas fa-times me-1"></i>Failed
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button class="btn btn-outline-primary btn-sm" 
                                                    data-email-index="{{ loop.index0 }}"
                                                    onclick="showEmailDetails(this)">
                                                <i class="fas fa-eye me-1"></i>View
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Compose Tab -->
            <div class="tab-pane fade" id="compose" role="tabpanel">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="compose-form">
                            <h5 class="mb-4">
                                <i class="fas fa-edit me-2"></i>Compose New Email
                            </h5>
                            <form id="composeForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="recipientEmail" class="form-label">Recipient Email</label>
                                        <input type="email" class="form-control" id="recipientEmail" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="recipientName" class="form-label">Recipient Name</label>
                                        <input type="text" class="form-control" id="recipientName" required>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="companyName" class="form-label">Company Name</label>
                                        <input type="text" class="form-control" id="companyName" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="position" class="form-label">Position</label>
                                        <input type="text" class="form-control" id="position" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="emailSubject" class="form-label">Subject</label>
                                    <input type="text" class="form-control" id="emailSubject" placeholder="Will be auto-generated based on recipient info">
                                </div>
                                <div class="mb-4">
                                    <label for="emailBody" class="form-label">Message</label>
                                    <textarea class="form-control" id="emailBody" rows="12" placeholder="Will be auto-generated based on recipient info"></textarea>
                                </div>
                                <div class="d-flex gap-3">
                                    <button type="button" class="btn btn-outline-primary" id="generatePreview">
                                        <i class="fas fa-magic me-2"></i>Generate Preview
                                    </button>
                                    <button type="submit" class="btn btn-primary" id="sendComposedEmail">
                                        <i class="fas fa-paper-plane me-2"></i>Send Email
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-lightbulb me-2"></i>Email Tips
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <h6 class="text-primary">Our AI Chatbot Solution</h6>
                                    <ul class="list-unstyled small text-muted">
                                        <li><i class="fas fa-check text-success me-2"></i>FAQ automation</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Website integration</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Multi-agent capabilities</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Multilingual support</li>
                                        <li><i class="fas fa-check text-success me-2"></i>CRM integration</li>
                                    </ul>
                                </div>
                                <div class="alert alert-info">
                                    <small>
                                        <strong>Pro Tip:</strong> Our AI will personalize each email based on the recipient's industry and role for maximum engagement.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Email Details Modal -->
    <div class="modal fade" id="emailDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-envelope me-2"></i>Email Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="emailDetailsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Send Confirmation Modal -->
    <div class="modal fade" id="sendConfirmationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-paper-plane me-2"></i>Confirm Email Send
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Please verify recipient information:</strong>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-3"><strong>Name:</strong></div>
                        <div class="col-sm-9" id="confirmName"></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-3"><strong>Email:</strong></div>
                        <div class="col-sm-9" id="confirmEmail"></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-3"><strong>Company:</strong></div>
                        <div class="col-sm-9" id="confirmCompany"></div>
                    </div>
                    <div class="email-preview">
                        <strong>Email Preview:</strong>
                        <div id="confirmPreview" class="mt-2"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmSendBtn">
                        <i class="fas fa-paper-plane me-2"></i>Confirm Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Send Modal -->
    <div class="modal fade" id="bulkSendModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-paper-plane me-2"></i>Send to All Contacts
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>You are about to send personalized emails to all contacts who haven't received emails yet.</strong>
                    </div>
                    <div id="recipientListContainer">
                        <div class="text-center py-4">
                            <div class="loading-spinner"></div>
                            <div class="mt-2">Loading recipient list...</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmBulkSendBtn" disabled>
                        <span class="loading-spinner d-none me-2" id="bulkSendSpinner"></span>
                        <i class="fas fa-paper-plane me-2"></i>
                        <span id="bulkSendBtnText">Send to All</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Toast -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
                <i class="fas fa-check-circle me-2"></i>
                <strong class="me-auto">Success!</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body"></div>
        </div>
        <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-danger text-white">
                <i class="fas fa-exclamation-circle me-2"></i>
                <strong class="me-auto">Error!</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Initialize data -->
    <script>
        window.emailHistoryData = {{ email_history_json|tojson|safe }};
    </script>
    
    <script>
        // Global variables
        let currentContacts = [];
        let emailHistory = window.emailHistoryData || [];
        
        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            loadEmailPreviews();
            setupEventListeners();
            setupSearch();
        });

        function setupEventListeners() {
            // Pagination
            document.getElementById('perPage').addEventListener('change', function() {
                changePage(1);
            });

            document.querySelectorAll('.pagination .page-link').forEach(link => {
                if (link.hasAttribute('data-page')) {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        changePage(parseInt(this.getAttribute('data-page')));
                    });
                }
            });

            // Bulk send
            document.getElementById('sendToAllBtn').addEventListener('click', showBulkSendModal);

            // Compose form
            document.getElementById('generatePreview').addEventListener('click', generateEmailPreview);
            document.getElementById('composeForm').addEventListener('submit', sendComposedEmail);
        }

        function setupSearch() {
            const searchInput = document.getElementById('contactSearch');
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const contactCards = document.querySelectorAll('.contact-card');
                
                contactCards.forEach(card => {
                    const text = card.textContent.toLowerCase();
                    const parent = card.closest('.col-lg-6, .col-xl-4');
                    if (text.includes(searchTerm)) {
                        parent.style.display = '';
                    } else {
                        parent.style.display = 'none';
                    }
                });
            });
        }

        function loadEmailPreviews() {
            document.querySelectorAll('.send-btn').forEach(button => {
                const leadInfo = {
                    name: button.dataset.leadName,
                    email: button.dataset.leadEmail,
                    company: button.dataset.leadCompany,
                    position: button.dataset.leadPosition
                };
                loadEmailPreview(button.dataset.leadIndex, leadInfo);
            });
        }

        function loadEmailPreview(index, leadInfo) {
            fetch('/api/preview_email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(leadInfo)
            })
            .then(response => response.json())
            .then(data => {
                const previewDiv = document.getElementById(`preview-${index}`);
                if (data.body) {
                    const preview = data.body.substring(0, 150) + '...';
                    previewDiv.innerHTML = `
                        <div class="small">
                            <strong>Subject:</strong> ${data.subject}<br>
                            <strong>Preview:</strong> ${preview}
                        </div>
                    `;
                } else {
                    previewDiv.innerHTML = '<div class="text-danger small">Error loading preview</div>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById(`preview-${index}`).innerHTML = '<div class="text-danger small">Error loading preview</div>';
            });
        }

        function changePage(page) {
            const perPage = document.getElementById('perPage').value;
            const url = new URL(window.location.href);
            url.searchParams.set('page', page);
            url.searchParams.set('per_page', perPage);
            window.location.href = url.toString();
        }

        function sendEmail(button) {
            const leadIndex = button.dataset.leadIndex;
            const leadName = button.dataset.leadName;
            const leadEmail = button.dataset.leadEmail;
            const leadCompany = button.dataset.leadCompany;
            const previewDiv = document.getElementById(`preview-${leadIndex}`);
            
            // Get email content from preview
            const previewContent = previewDiv.textContent;
            const subjectMatch = previewContent.match(/Subject:\s*(.+)/);
            const subject = subjectMatch ? subjectMatch[1] : 'Default Subject';
            
            // Show confirmation modal
            document.getElementById('confirmName').textContent = leadName;
            document.getElementById('confirmEmail').textContent = leadEmail;
            document.getElementById('confirmCompany').textContent = leadCompany;
            document.getElementById('confirmPreview').textContent = previewContent;
            
            const modal = new bootstrap.Modal(document.getElementById('sendConfirmationModal'));
            modal.show();
            
            // Set up confirmation
            document.getElementById('confirmSendBtn').onclick = function() {
                modal.hide();
                
                // Generate full email content
                fetch('/api/preview_email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: leadName,
                        email: leadEmail,
                        company: leadCompany,
                        position: button.dataset.leadPosition
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // Send the email
                    return fetch('/api/send_email', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `lead_index=${leadIndex}&recipient_email=${encodeURIComponent(leadEmail)}&recipient_name=${encodeURIComponent(leadName)}&preview_subject=${encodeURIComponent(data.subject)}&preview_body=${encodeURIComponent(data.body)}`
                    });
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('successToast', 'Email sent successfully!');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast('errorToast', data.message || 'Failed to send email');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('errorToast', 'An error occurred while sending the email');
                });
            };
        }

        function showBulkSendModal() {
            const modal = new bootstrap.Modal(document.getElementById('bulkSendModal'));
            modal.show();
            
            fetch('/api/get_unsent_leads')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('recipientListContainer');
                    
                    if (data.count === 0) {
                        container.innerHTML = '<div class="alert alert-info">No unsent recipients found.</div>';
                        return;
                    }
                    
                    const recipientHtml = `
                        <div class="alert alert-success">
                            <i class="fas fa-users me-2"></i>
                            Ready to send to <strong>${data.count}</strong> recipients
                        </div>
                        <div class="list-group">
                            ${data.unsent_leads.slice(0, 10).map(lead => `
                                <div class="list-group-item">
                                    <div class="d-flex align-items-center">
                                        <div class="contact-avatar me-3" style="width: 32px; height: 32px; font-size: 0.75rem;">
                                            ${(lead['First Name'] || '?')[0].toUpperCase()}
                                        </div>
                                        <div>
                                            <strong>${lead['First Name'] || ''} ${lead['Last Name'] || ''}</strong>
                                            <div class="small text-muted">${lead['Work Email'] || ''}</div>
                                            <div class="small text-muted">${lead['Company Name'] || ''}</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                            ${data.count > 10 ? `<div class="list-group-item text-center text-muted">...and ${data.count - 10} more</div>` : ''}
                        </div>
                    `;
                    
                    container.innerHTML = recipientHtml;
                    document.getElementById('confirmBulkSendBtn').disabled = false;
                    
                    // Store data for sending
                    window.unsentLeads = data.unsent_leads;
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('recipientListContainer').innerHTML = 
                        '<div class="alert alert-danger">Error loading recipients</div>';
                });
        }

        function generateEmailPreview() {
            const leadInfo = {
                name: document.getElementById('recipientName').value,
                email: document.getElementById('recipientEmail').value,
                company: document.getElementById('companyName').value,
                position: document.getElementById('position').value
            };

            if (!leadInfo.name || !leadInfo.email || !leadInfo.company) {
                showToast('errorToast', 'Please fill in all required fields');
                return;
            }

            fetch('/api/preview_email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(leadInfo)
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('emailSubject').value = data.subject;
                document.getElementById('emailBody').value = data.body;
                showToast('successToast', 'Email preview generated!');
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('errorToast', 'Failed to generate preview');
            });
        }

        function sendComposedEmail(e) {
            e.preventDefault();
            
            const subject = document.getElementById('emailSubject').value;
            const body = document.getElementById('emailBody').value;
            const email = document.getElementById('recipientEmail').value;
            const name = document.getElementById('recipientName').value;

            if (!subject || !body || !email || !name) {
                showToast('errorToast', 'Please fill in all fields');
                return;
            }

            fetch('/api/send_email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `lead_index=0&recipient_email=${encodeURIComponent(email)}&recipient_name=${encodeURIComponent(name)}&preview_subject=${encodeURIComponent(subject)}&preview_body=${encodeURIComponent(body)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('successToast', 'Email sent successfully!');
                    document.getElementById('composeForm').reset();
                } else {
                    showToast('errorToast', data.message || 'Failed to send email');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('errorToast', 'An error occurred while sending the email');
            });
        }

        function showEmailDetails(button) {
            const emailIndex = button.dataset.emailIndex;
            const email = emailHistory[emailIndex];
            
            const content = `
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>Date:</strong></div>
                    <div class="col-sm-9">${email.date}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>To:</strong></div>
                    <div class="col-sm-9">${email.to}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>Subject:</strong></div>
                    <div class="col-sm-9">${email.subject}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>Status:</strong></div>
                    <div class="col-sm-9">${email.status}</div>
                </div>
                <hr>
                <h6>Message:</h6>
                <div class="email-preview">${email.body.replace(/\n/g, '<br>')}</div>
            `;
            
            document.getElementById('emailDetailsContent').innerHTML = content;
            new bootstrap.Modal(document.getElementById('emailDetailsModal')).show();
        }

        function showToast(toastId, message) {
            const toast = document.getElementById(toastId);
            toast.querySelector('.toast-body').textContent = message;
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        // Make sendEmail function globally accessible
        window.sendEmail = sendEmail;

        // Bulk send functionality
        document.getElementById('confirmBulkSendBtn').addEventListener('click', function() {
            if (!window.unsentLeads || window.unsentLeads.length === 0) {
                showToast('errorToast', 'No recipients to send to');
                return;
            }
            
            this.disabled = true;
            document.getElementById('bulkSendSpinner').classList.remove('d-none');
            document.getElementById('bulkSendBtnText').textContent = 'Sending...';
            
            fetch('/api/send_bulk_emails', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    recipients: window.unsentLeads
                })
            })
            .then(response => response.json())
            .then(data => {
                bootstrap.Modal.getInstance(document.getElementById('bulkSendModal')).hide();
                
                if (data.success) {
                    showToast('successToast', `Successfully sent ${data.results.success} emails!`);
                } else {
                    showToast('errorToast', `Sent ${data.results.success} emails, ${data.results.failed} failed`);
                }
                
                setTimeout(() => location.reload(), 2000);
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('errorToast', 'Bulk send failed');
            })
            .finally(() => {
                this.disabled = false;
                document.getElementById('bulkSendSpinner').classList.add('d-none');
                document.getElementById('bulkSendBtnText').textContent = 'Send to All';
            });
        });
    </script>
</body>
</html> 