{% extends "base.html" %}

{% block title %}SalesBot CRM - Dashboard{% endblock %}

{% block data_init %}
<script>
    window.emailHistoryData = {{ email_history_json|tojson }};
</script>
{% endblock %}

{% block content %}

<!-- First-Time User Welcome Banner -->
{% if session.user and session.user.is_first_login %}
<div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
    <div class="d-flex align-items-center">
        <i class="fas fa-rocket fa-2x me-3 text-primary"></i>
        <div>
            <h5 class="alert-heading mb-1">Welcome to SalesBot, {{ session.user.name }}! ðŸš€</h5>
            <p class="mb-0">Ready to supercharge your sales outreach? <a href="/settings?tab=api-keys" class="alert-link">Configure your API keys</a> and <a href="/settings?tab=email" class="alert-link">email settings</a> to get started.</p>
        </div>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<!-- Stats Overview -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stats-card">
            <div class="stats-number" id="totalContacts">{{ total_contacts }}</div>
            <div class="stats-label">Total Contacts</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stats-card">
            <div class="stats-number" id="emailsSent">{{ emails_sent }}</div>
            <div class="stats-label">Emails Sent</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stats-card">
            <div class="stats-number" id="successRate">{{ success_rate }}%</div>
            <div class="stats-label">Success Rate</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stats-card">
            <div class="stats-number" id="uncontactedContacts">{{ uncontacted_count }}</div>
            <div class="stats-label">Uncontacted</div>
        </div>
    </div>
</div>

<!-- Tab Navigation with Admin Actions -->
<ul class="nav nav-tabs main-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="contacts-tab" data-bs-toggle="tab" data-bs-target="#contacts-tab-pane" type="button" role="tab" aria-controls="contacts-tab-pane" aria-selected="true">
            <i class="fas fa-users me-1"></i> Contacts
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="companies-tab" data-bs-toggle="tab" data-bs-target="#companies-tab-pane" type="button" role="tab" aria-controls="companies-tab-pane" aria-selected="false">
            <i class="fas fa-building me-1"></i> Companies
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="inbox-tab" data-bs-toggle="tab" data-bs-target="#inbox-tab-pane" type="button" role="tab" aria-controls="inbox-tab-pane" aria-selected="false">
            <i class="fas fa-inbox me-1"></i> Inbox
            {% if threads and threads|length > 0 %}
                <span class="badge bg-danger ms-2">{{ threads|length }}</span>
            {% endif %}
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="compose-tab" data-bs-toggle="tab" data-bs-target="#compose-tab-pane" type="button" role="tab" aria-controls="compose-tab-pane" aria-selected="false">
            <i class="fas fa-edit me-1"></i> Compose
        </button>
    </li>
    {% if enable_gtm_campaign_tab %}
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="gtm-campaign-tab" data-bs-toggle="tab" data-bs-target="#gtm-campaign-tab-pane" type="button" role="tab" aria-controls="gtm-campaign-tab-pane" aria-selected="false">
            <i class="fas fa-bullhorn me-1"></i> GTM Campaign
        </button>
    </li>
    {% endif %}
    <li class="nav-item dropdown ms-auto" role="presentation">
        <button class="nav-link dropdown-toggle text-danger" id="adminDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="border: none; background: none;">
            <i class="fas fa-cog me-1"></i> Admin
        </button>
        <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="adminDropdown">
            <li>
                <h6 class="dropdown-header">
                    <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                    Danger Zone
                </h6>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li>
                <button class="dropdown-item text-danger d-flex align-items-center" id="cleanDatabaseBtn">
                    <i class="fas fa-trash me-2"></i>
                    <div>
                        <div class="fw-bold">Clear My Data</div>
                        <small class="text-muted">Remove all your contacts, companies, and campaigns</small>
                    </div>
                </button>
            </li>
        </ul>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="mainTabsContent">
    <!-- Contacts Tab -->
    <div class="tab-pane fade show active" id="contacts-tab-pane" role="tabpanel" aria-labelledby="contacts-tab">
        {% include 'components/contacts_pane.html' %}
    </div>

    <!-- Companies Tab -->
    <div class="tab-pane fade" id="companies-tab-pane" role="tabpanel" aria-labelledby="companies-tab">
        <div class="card">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-building me-2"></i>Company Database
                        </h5>
                        <small class="text-muted">Researched company information</small>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-end align-items-center gap-2">
                            <div class="input-group" style="max-width: 280px;">
                                <input type="text" class="form-control form-control-sm search-box" placeholder="Search companies..." id="companySearch">
                                <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearCompanySearch()" title="Clear search">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-primary btn-sm" id="extractCompaniesBtn" title="Extract companies from contacts">
                                    <i class="fas fa-download me-1"></i>Extract
                                </button>
                                <button class="btn btn-outline-primary btn-sm" id="researchCompaniesBtn" title="Start AI research for companies">
                                    <i class="fas fa-search me-1"></i>Research
                                </button>
                                <button class="btn btn-outline-danger btn-sm" id="cleanAllResearchBtn" title="Clean all research data from all companies">
                                    <i class="fas fa-trash me-1"></i>Clean All
                                </button>
                                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addCompanyModal">
                                    <i class="fas fa-plus me-1"></i>Add Company
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                 <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number">{{ total_companies }}</div>
                            <div class="stats-label">Total Companies</div>
                        </div>
                    </div>
                </div>
                <div id="companies-table-container">
                    {% include 'components/companies_table.html' %}
                </div>
            </div>
        </div>
    </div>

    <!-- Inbox Tab -->
    <div class="tab-pane fade" id="inbox-tab-pane" role="tabpanel" aria-labelledby="inbox-tab">
        {% include 'components/inbox_pane.html' %}
    </div>
    
    <!-- Compose Tab -->
    <div class="tab-pane fade" id="compose-tab-pane" role="tabpanel" aria-labelledby="compose-tab">
        {% include 'components/compose_form.html' %}
    </div>

    <!-- GTM Campaign Tab -->
    {% if enable_gtm_campaign_tab %}
    <div class="tab-pane fade" id="gtm-campaign-tab-pane" role="tabpanel" aria-labelledby="gtm-campaign-tab">
        {% include 'components/gtm_campaign_pane.html' %}
    </div>
    {% endif %}
</div>

<!-- Modals -->
{% include 'components/contact_detail_modal.html' %}
{% include 'components/email_details_modal.html' %}
{% include 'components/add_contact_modal.html' %}
{% include 'components/add_company_modal.html' %}
{% include 'components/company_detail_modal.html' %}
{% include 'components/deep_research_modal.html' %}

<!-- Success/Error Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <i class="fas fa-check-circle me-2"></i>
            <strong class="me-auto">Success!</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body"></div>
    </div>
    <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-danger text-white">
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong class="me-auto">Error!</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Include marked.js for markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- Refactored JavaScript modules -->
<script src="{{ url_for('static', filename='js/utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/contacts.js') }}"></script>
<script src="{{ url_for('static', filename='js/email.js') }}"></script>
<script src="{{ url_for('static', filename='js/campaigns.js') }}"></script>
<script src="{{ url_for('static', filename='js/companies.js') }}"></script>

<!-- Clear User Data functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const cleanDatabaseBtn = document.getElementById('cleanDatabaseBtn');
    
    if (cleanDatabaseBtn) {
        cleanDatabaseBtn.addEventListener('click', function() {
            // Close the dropdown
            const dropdownMenu = this.closest('.dropdown-menu');
            if (dropdownMenu) {
                const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('adminDropdown'));
                if (dropdown) dropdown.hide();
            }
            
            // Show confirmation modal instead of immediate execution
            const confirmModal = new bootstrap.Modal(document.getElementById('cleanDatabaseModal') || createCleanDatabaseModal());
            confirmModal.show();
        });
    }
    
    function createCleanDatabaseModal() {
        const modalHTML = `
            <div class="modal fade" id="cleanDatabaseModal" tabindex="-1" aria-labelledby="cleanDatabaseModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-danger">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title" id="cleanDatabaseModalLabel">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Clear Your Data
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-danger d-flex align-items-center" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <div>
                                    <strong>Warning:</strong> This will permanently delete YOUR data only.
                                </div>
                            </div>
                            <p class="mb-3">This will remove from your account:</p>
                            <ul class="mb-3">
                                <li>Your contacts and companies</li>
                                <li>Your campaigns and email history</li>
                                <li>Your research data and reports</li>
                                <li>Your API keys and email configurations</li>
                                <li>Your settings and preferences</li>
                            </ul>
                            <div class="alert alert-info small mb-3">
                                <i class="fas fa-info-circle me-1"></i> 
                                <strong>Note:</strong> Other users' data will not be affected.
                            </div>
                            <p class="text-muted"><strong>This action cannot be undone.</strong></p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i> Cancel
                            </button>
                            <button type="button" class="btn btn-danger" id="confirmCleanDatabase">
                                <i class="fas fa-trash me-1"></i> Yes, Clear My Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        const modal = document.getElementById('cleanDatabaseModal');
        
        // Add event listener for confirm button
        document.getElementById('confirmCleanDatabase').addEventListener('click', function() {
            executeCleanDatabase();
            bootstrap.Modal.getInstance(modal).hide();
        });
        
        return modal;
    }
    
    function executeCleanDatabase() {
        const confirmBtn = document.getElementById('confirmCleanDatabase');
        const originalHTML = confirmBtn ? confirmBtn.innerHTML : '';
        
        if (confirmBtn) {
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Cleaning...';
            confirmBtn.disabled = true;
        }
        
        fetch('/api/clean-database', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Your data has been cleared successfully! Refreshing dashboard...', 'success');
                // Refresh the page to update stats
                setTimeout(() => location.reload(), 2000);
            } else {
                showToast('Failed to clear your data: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error clearing your data: ' + error.message, 'error');
        })
        .finally(() => {
            // Restore button state
            if (confirmBtn) {
                confirmBtn.innerHTML = originalHTML;
                confirmBtn.disabled = false;
            }
        });
    }
});
</script>

<!-- Main dashboard coordination script -->
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>

<!-- Deep Research Modal functionality -->
<script>
    // Configuration passed from backend
    window.NETLIFY_PUBLISH_URL = "{{ netlify_publish_url }}";
</script>
<script src="{{ url_for('static', filename='js/deep-research.js') }}"></script>

<!-- Follow-up Email Modal functionality -->
<script>
// Global modal instance and context storage
let followUpModalInstance = null;
let currentEmailContext = {};

function composeFollowUp(recipient, originalSubject, originalFrom, originalEmailBody = '', messageId = '') {
    console.log('composeFollowUp called with:', { recipient, originalSubject, originalFrom, messageId });
    
    // Store context for AI draft generation and threading
    currentEmailContext = {
        recipient: recipient,
        subject: originalSubject,
        from: originalFrom,
        originalBody: originalEmailBody,
        messageId: messageId
    };
    
    // Set modal values immediately
    document.getElementById('followUpRecipient').value = recipient;
    
    // Only add "Re:" if it's not already there
    let replySubject = originalSubject;
    if (!originalSubject.toLowerCase().startsWith('re:')) {
        replySubject = 'Re: ' + originalSubject;
    }
    document.getElementById('followUpSubject').value = replySubject;
    document.getElementById('followUpBody').value = '';
    
    // Create modal instance only once
    const modalElement = document.getElementById('followUpModal');
    if (modalElement) {
        if (!followUpModalInstance) {
            followUpModalInstance = new bootstrap.Modal(modalElement);
            console.log('Created new modal instance');
        }
        
        followUpModalInstance.show();
        console.log('Modal shown using persistent instance');
    }
}

// Event delegation for follow-up buttons (prevents accordion conflicts)
document.addEventListener('DOMContentLoaded', function() {
    // Handle follow-up button clicks using event delegation
    document.addEventListener('click', function(e) {
        // Check if it's specifically our button
        const followupBtn = e.target.closest('.followup-btn');
        if (followupBtn) {
            e.preventDefault();
            e.stopImmediatePropagation();
            
            // Add a flag to prevent multiple triggers
            if (followupBtn.hasAttribute('data-processing')) {
                return;
            }
            
            followupBtn.setAttribute('data-processing', 'true');
            
            const recipient = followupBtn.getAttribute('data-recipient');
            const subject = followupBtn.getAttribute('data-subject');
            const from = followupBtn.getAttribute('data-from');
            const originalBody = followupBtn.getAttribute('data-original-body') || '';
            const messageId = followupBtn.getAttribute('data-message-id') || '';
            
            // Call the compose function
            composeFollowUp(recipient, subject, from, originalBody, messageId);
            
            // Remove processing flag after a short delay
            setTimeout(() => {
                followupBtn.removeAttribute('data-processing');
            }, 2000);
        }
    });

    // Generate AI Draft functionality
    const generateDraftBtn = document.getElementById('generateDraftBtn');
    if (generateDraftBtn) {
        generateDraftBtn.addEventListener('click', function() {
            console.log('Generate AI Draft clicked');
            
            // Disable button and show loading state
            generateDraftBtn.disabled = true;
            const originalHTML = generateDraftBtn.innerHTML;
            generateDraftBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating...';
            
            // Call AI draft generation API
            fetch('/api/generate-followup-draft', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    recipient: currentEmailContext.recipient,
                    subject: currentEmailContext.subject,
                    original_context: currentEmailContext.originalBody || ''
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Insert the generated draft into the textarea
                    const bodyField = document.getElementById('followUpBody');
                    bodyField.value = data.draft;
                    showToast('AI draft generated successfully!', 'success');
                } else {
                    showToast('Failed to generate draft: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error generating draft:', error);
                showToast('Error generating draft: ' + error.message, 'error');
            })
            .finally(() => {
                // Restore button state
                generateDraftBtn.disabled = false;
                generateDraftBtn.innerHTML = originalHTML;
            });
        });
    }

    // Send follow-up email
    const sendBtn = document.getElementById('sendFollowUpBtn');
    if (sendBtn) {
        sendBtn.addEventListener('click', function() {
            const recipient = document.getElementById('followUpRecipient').value;
            const subject = document.getElementById('followUpSubject').value;
            const body = document.getElementById('followUpBody').value;
            const includeTracking = document.getElementById('followUpTracking').checked;
            
            if (!body.trim()) {
                showToast('Please enter a message body', 'error');
                return;
            }
            
            // Disable button and show loading
            sendBtn.disabled = true;
            const originalHTML = sendBtn.innerHTML;
            sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Sending...';
            
            // Send follow-up email
            fetch('/api/send-followup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    recipient: recipient,
                    subject: subject,
                    body: body,
                    include_tracking: includeTracking,
                    original_message_id: currentEmailContext.messageId || null
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Follow-up email sent successfully!', 'success');
                    // Hide modal
                    bootstrap.Modal.getInstance(document.getElementById('followUpModal')).hide();
                    // Clear form
                    document.getElementById('followUpBody').value = '';
                } else {
                    showToast('Failed to send follow-up: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error sending follow-up: ' + error.message, 'error');
            })
            .finally(() => {
                // Restore button state
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalHTML;
            });
        });
    }
});
</script>

<!-- Include Onboarding Modal for First-Time Users -->
{% if session.user and session.user.is_first_login %}
{% include 'onboarding_modal.html' %}
{% endif %}

{% endblock %} 