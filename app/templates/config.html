{% extends "base.html" %}

{% block title %}Email Configuration - SalesBot{% endblock %}

{% block extra_css %}
<style>
.config-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
    border-radius: 15px;
}

.config-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    overflow: hidden;
}

.config-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
}

.account-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.account-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea, #764ba2);
}

.account-card.default-account::before {
    background: linear-gradient(90deg, #f093fb, #f5576c);
}

.account-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.12);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
}

.stat-item {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    text-align: center;
    border-left: 4px solid #667eea;
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: #667eea;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #6c757d;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #6c757d;
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 1.5rem;
    opacity: 0.5;
}

.btn-gradient {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    transition: all 0.3s ease;
}

.btn-gradient:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    color: white;
}

.provider-hint {
    background: #f8f9fa;
    border-left: 4px solid #17a2b8;
    padding: 0.75rem 1rem;
    margin-top: 0.5rem;
    border-radius: 0 8px 8px 0;
    font-size: 0.9rem;
}

.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.modal-content {
    border: none;
    border-radius: 15px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
}

.modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px 15px 0 0;
}

.connection-status {
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-size: 0.85rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.connection-status.connected {
    background: #d4edda;
    color: #155724;
}

.connection-status.disconnected {
    background: #f8d7da;
    color: #721c24;
}

.provider-badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
}

.step-indicator {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.step-indicator.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.form-control-lg {
    padding: 0.75rem 1rem;
    font-size: 1rem;
}

.input-group .btn {
    border-left: none;
}

.alert-dismissible {
    position: relative;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Enhanced Header -->
    <div class="config-header text-center">
        <div class="container">
            <h1 class="mb-3">
                <i class="fas fa-cogs me-3"></i>
                Email Configuration
            </h1>
            <p class="lead mb-4">Manage your email accounts for seamless communication</p>
            <div class="d-flex justify-content-center gap-3">
                <button class="btn btn-light btn-lg" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                    <i class="fas fa-plus me-2"></i> Add New Account
                </button>
                <button class="btn btn-outline-light btn-lg" onclick="saveConfiguration()">
                    <i class="fas fa-save me-2"></i> Save Configuration
                </button>
            </div>
        </div>
    </div>

    <!-- Alert for messages -->
    <div id="configAlert" class="alert d-none" role="alert"></div>

    <!-- Stats Overview -->
    <div class="stats-grid mb-4">
        <div class="stat-item">
            <div class="stat-number" id="totalAccounts">0</div>
            <div class="stat-label">Total Accounts</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="configSource">Loading...</div>
            <div class="stat-label">Configuration Type</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="defaultAccountName">None</div>
            <div class="stat-label">Default Account</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="connectedAccounts">0</div>
            <div class="stat-label">Ready to Use</div>
        </div>
    </div>

    <!-- Email Accounts Grid -->
    <div class="config-card">
        <div class="card-header bg-white border-0 py-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-1">
                        <i class="fas fa-envelope-open-text text-primary me-2"></i>
                        Email Accounts
                    </h4>
                    <p class="text-muted mb-0">Configure and manage your email sending accounts</p>
                </div>
                <button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                    <i class="fas fa-plus me-2"></i> Add Account
                </button>
            </div>
        </div>
        <div class="card-body p-4">
            <div id="accountsList" class="row g-4">
                <!-- Accounts will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Add Account Modal -->
<div class="modal fade" id="addAccountModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header border-0">
                <div>
                    <h4 class="modal-title mb-1">
                        <i class="fas fa-plus-circle me-2"></i>Add New Email Account
                    </h4>
                    <p class="mb-0 text-white-50">Configure your email account for sending campaigns</p>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="container-fluid">
                    <!-- Progress Steps -->
                    <div class="bg-light py-3 px-4 border-bottom">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="d-flex align-items-center">
                                    <div class="step-indicator active me-3">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0">Account Details</h6>
                                        <small class="text-muted">Basic information and credentials</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="d-flex align-items-center">
                                    <div class="step-indicator me-3" id="serverStep">
                                        <i class="fas fa-server"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0">Server Settings</h6>
                                        <small class="text-muted">SMTP and IMAP configuration</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <form id="addAccountForm" class="p-4">
                        <!-- Basic Account Information -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-info-circle me-2"></i>Basic Information
                                </h5>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="accountName" class="form-label fw-semibold">
                                        Account Name <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control form-control-lg" id="accountName" required
                                           placeholder="e.g., Primary, Sales, Support">
                                    <div class="form-text">
                                        <i class="fas fa-lightbulb text-warning me-1"></i>
                                        Choose a descriptive name to identify this account
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="accountEmail" class="form-label fw-semibold">
                                        Email Address <span class="text-danger">*</span>
                                    </label>
                                    <input type="email" class="form-control form-control-lg" id="accountEmail" required
                                           placeholder="your.email@company.com">
                                    <div id="providerDetection" class="provider-hint d-none">
                                        <i class="fas fa-magic text-info me-1"></i>
                                        <span id="providerText">Provider auto-detected</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="accountPassword" class="form-label fw-semibold">
                                        Password <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="password" class="form-control form-control-lg" id="accountPassword" required
                                               placeholder="Enter your email password or app password">
                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('accountPassword')">
                                            <i class="fas fa-eye" id="accountPassword-icon"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        <i class="fas fa-shield-alt text-success me-1"></i>
                                        For Gmail/Outlook, use an App Password. For Zoho, use your regular password.
                                        <a href="#" class="text-decoration-none" onclick="showPasswordHelp()">Need help?</a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Server Configuration -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="text-primary mb-0">
                                        <i class="fas fa-server me-2"></i>Server Settings
                                    </h5>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="advancedMode">
                                        <label class="form-check-label fw-semibold" for="advancedMode">
                                            Advanced Mode
                                        </label>
                                    </div>
                                </div>
                                <p class="text-muted mb-3">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Settings will be auto-detected based on your email provider. Enable Advanced Mode for manual configuration.
                                </p>
                            </div>
                        </div>

                        <div id="advancedSettings" class="d-none">
                            <!-- SMTP Settings -->
                            <div class="row mb-4">
                                <div class="col-12 mb-3">
                                    <h6 class="text-secondary">
                                        <i class="fas fa-paper-plane me-2"></i>SMTP (Outgoing Mail)
                                    </h6>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="smtpHost" class="form-label">SMTP Host</label>
                                        <input type="text" class="form-control" id="smtpHost" 
                                               placeholder="smtp.gmail.com">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="smtpPort" class="form-label">SMTP Port</label>
                                        <select class="form-select" id="smtpPort">
                                            <option value="465" selected>465 (SSL)</option>
                                            <option value="587">587 (TLS)</option>
                                            <option value="25">25 (Insecure)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Security</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="smtpSsl" checked>
                                            <label class="form-check-label" for="smtpSsl">Use SSL/TLS</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- IMAP Settings -->
                            <div class="row mb-4">
                                <div class="col-12 mb-3">
                                    <h6 class="text-secondary">
                                        <i class="fas fa-inbox me-2"></i>IMAP (Incoming Mail)
                                    </h6>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="imapHost" class="form-label">IMAP Host</label>
                                        <input type="text" class="form-control" id="imapHost" 
                                               placeholder="imap.gmail.com">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="imapPort" class="form-label">IMAP Port</label>
                                        <select class="form-select" id="imapPort">
                                            <option value="993" selected>993 (SSL)</option>
                                            <option value="143">143 (TLS)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Security</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="imapSsl" checked>
                                            <label class="form-check-label" for="imapSsl">Use SSL/TLS</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Account Options -->
                        <div class="row">
                            <div class="col-12">
                                <div class="bg-light p-3 rounded">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="isDefault">
                                        <label class="form-check-label fw-semibold" for="isDefault">
                                            <i class="fas fa-star text-warning me-2"></i>
                                            Set as default account for sending emails
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer bg-light border-0">
                <button type="button" class="btn btn-light btn-lg" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-gradient btn-lg px-4" onclick="addAccount()">
                    <i class="fas fa-plus me-2"></i>Add Account
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Account Modal -->
<div class="modal fade" id="editAccountModal" tabindex="-1" aria-labelledby="editAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAccountModalLabel">Edit Email Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editAccountForm">
                    <input type="hidden" id="editAccountIndex">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editAccountName" class="form-label">Account Name *</label>
                                <input type="text" class="form-control" id="editAccountName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editAccountEmail" class="form-label">Email Address *</label>
                                <input type="email" class="form-control" id="editAccountEmail" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editAccountPassword" class="form-label">Password *</label>
                        <input type="password" class="form-control" id="editAccountPassword" required>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editSmtpHost" class="form-label">SMTP Host</label>
                                <input type="text" class="form-control" id="editSmtpHost">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="editSmtpPort" class="form-label">SMTP Port</label>
                                <input type="number" class="form-control" id="editSmtpPort">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">SMTP SSL</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editSmtpSsl">
                                    <label class="form-check-label" for="editSmtpSsl">Use SSL</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editImapHost" class="form-label">IMAP Host</label>
                                <input type="text" class="form-control" id="editImapHost">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="editImapPort" class="form-label">IMAP Port</label>
                                <input type="number" class="form-control" id="editImapPort">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">IMAP SSL</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editImapSsl">
                                    <label class="form-check-label" for="editImapSsl">Use SSL</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editIsDefault">
                            <label class="form-check-label" for="editIsDefault">
                                Set as default account
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateAccount()">Update Account</button>
            </div>
        </div>
    </div>
</div>

<script>
let emailAccounts = [];
let currentProvider = null;

// Email provider configurations
const emailProviders = {
    gmail: {
        name: 'Gmail',
        domains: ['gmail.com', 'googlemail.com'],
        smtp: { host: 'smtp.gmail.com', port: 587, ssl: true },
        imap: { host: 'imap.gmail.com', port: 993, ssl: true },
        helpUrl: 'https://support.google.com/accounts/answer/185833',
        color: '#ea4335'
    },
    outlook: {
        name: 'Outlook/Hotmail',
        domains: ['outlook.com', 'hotmail.com', 'live.com'],
        smtp: { host: 'smtp-mail.outlook.com', port: 587, ssl: true },
        imap: { host: 'outlook.office365.com', port: 993, ssl: true },
        helpUrl: 'https://support.microsoft.com/en-us/office/pop-imap-and-smtp-settings-8361e398-8af4-4e97-b147-6c6c4ac95353',
        color: '#0078d4'
    },
    zoho: {
        name: 'Zoho Mail',
        domains: ['zoho.com', 'zoho.in', 'possiblemindshq.com', 'possibleminds.in'],
        smtp: { host: 'smtppro.zoho.in', port: 465, ssl: true },
        imap: { host: 'imap.zoho.com', port: 993, ssl: true },
        helpUrl: 'https://www.zoho.com/mail/help/imap-access.html',
        color: '#e91e63'
    }
};

document.addEventListener('DOMContentLoaded', function() {
    loadConfiguration();
    setupEventListeners();
});

function setupEventListeners() {
    // Advanced mode toggle
    document.getElementById('advancedMode').addEventListener('change', function() {
        const advancedSettings = document.getElementById('advancedSettings');
        const serverStep = document.getElementById('serverStep');
        
        if (this.checked) {
            advancedSettings.classList.remove('d-none');
            serverStep.classList.add('active');
        } else {
            advancedSettings.classList.add('d-none');
            serverStep.classList.remove('active');
        }
    });

    // Email input auto-detection
    document.getElementById('accountEmail').addEventListener('input', function() {
        autoDetectProvider(this.value);
        generateAccountName(this.value);
    });

    // Port change handlers
    document.getElementById('smtpPort').addEventListener('change', function() {
        updateSSLCheckbox('smtp', this.value);
    });

    document.getElementById('imapPort').addEventListener('change', function() {
        updateSSLCheckbox('imap', this.value);
    });
}

function loadConfiguration() {
    fetch('/api/email/accounts')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                emailAccounts = data.accounts;
                updateStats(data.env_info);
                renderAccounts();
            } else {
                showAlert('Error loading configuration: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error loading configuration:', error);
            showAlert('Error loading configuration', 'danger');
        });
}

function updateStats(envInfo) {
    const defaultAccount = emailAccounts.find(acc => acc.is_default);
    
    document.getElementById('totalAccounts').textContent = emailAccounts.length;
    document.getElementById('configSource').textContent = envInfo ? envInfo.config_source : 'JSON Config File';
    document.getElementById('defaultAccountName').textContent = defaultAccount ? defaultAccount.name : 'None';
    document.getElementById('connectedAccounts').textContent = emailAccounts.length;
    
    // Show config storage info if available
    if (envInfo) {
        const sourceElement = document.getElementById('configSource');
        const storageFile = envInfo.primary_env_file || 'email_accounts_config.json';
        sourceElement.title = `Config stored in: ${storageFile}\nStorage type: ${envInfo.config_source}`;
        
        // Add visual indicator for JSON config vs env variable
        if (envInfo.config_source === 'JSON config file') {
            sourceElement.className = 'stat-number text-success';
            sourceElement.title += '\n✓ Using persistent JSON configuration';
        } else {
            sourceElement.className = 'stat-number text-warning';
            sourceElement.title += '\n⚠ Using environment variable (will migrate to JSON)';
        }
        
        // Show warning if .env2 exists but .env is used (for legacy configs)
        if (envInfo.env2_exists && !envInfo.env_exists && envInfo.config_source !== 'JSON config file') {
            sourceElement.className = 'stat-number text-danger';
            sourceElement.title += '\n⚠ WARNING: .env2 file exists but .env is being used!';
        }
    }
    
    // Auto-set first account as default if none exists
    if (emailAccounts.length > 0 && !defaultAccount) {
        document.getElementById('isDefault').checked = true;
    }
}

function renderAccounts() {
    const container = document.getElementById('accountsList');
    container.innerHTML = '';

    if (emailAccounts.length === 0) {
        container.innerHTML = `
            <div class="col-12">
                <div class="empty-state">
                    <i class="fas fa-envelope-plus"></i>
                    <h4>No Email Accounts Configured</h4>
                    <p class="mb-4">Get started by adding your first email account for sending campaigns.</p>
                    <button class="btn btn-gradient btn-lg" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                        <i class="fas fa-plus me-2"></i>Add Your First Account
                    </button>
                </div>
            </div>
        `;
        return;
    }

    emailAccounts.forEach((account, index) => {
        const provider = detectProvider(account.email);
        const providerInfo = provider ? emailProviders[provider] : null;
        
        const accountCard = `
            <div class="col-lg-4 col-md-6">
                <div class="account-card ${account.is_default ? 'default-account' : ''}">
                    ${providerInfo ? `<div class="provider-badge" style="background-color: ${providerInfo.color}20; color: ${providerInfo.color}">${providerInfo.name}</div>` : ''}
                    
                    <div class="card-header bg-white border-0 d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="card-title mb-1">
                                ${account.name}
                                ${account.is_default ? '<i class="fas fa-star text-warning ms-2" title="Default Account"></i>' : ''}
                            </h5>
                            <p class="text-muted mb-0 small">${account.email}</p>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="testConnection('${account.name}')">
                                    <i class="fas fa-check-circle text-success me-2"></i> Test Connection
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="editAccount(${index})">
                                    <i class="fas fa-edit text-primary me-2"></i> Edit Account
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteAccount(${index})">
                                    <i class="fas fa-trash me-2"></i> Delete Account
                                </a></li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-paper-plane text-primary me-2"></i>
                                    <div>
                                        <small class="text-muted d-block">SMTP</small>
                                        <small class="fw-semibold">${account.smtp_host ? `${account.smtp_host}:${account.smtp_port}` : 'Not configured'}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-inbox text-info me-2"></i>
                                    <div>
                                        <small class="text-muted d-block">IMAP</small>
                                        <small class="fw-semibold">${account.imap_host ? `${account.imap_host}:${account.imap_port}` : 'Not configured'}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3 d-flex gap-2">
                            <button class="btn btn-outline-primary btn-sm flex-fill" onclick="testConnection('${account.name}')">
                                <i class="fas fa-plug me-1"></i> Test
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="editAccount(${index})" title="Edit Account">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += accountCard;
    });
}

// Provider detection and auto-configuration
function detectProvider(email) {
    if (!email.includes('@')) return null;
    
    const domain = email.split('@')[1].toLowerCase();
    
    for (const [key, provider] of Object.entries(emailProviders)) {
        if (provider.domains.some(d => domain.includes(d))) {
            return key;
        }
    }
    return null;
}

function autoDetectProvider(email) {
    const provider = detectProvider(email);
    const detectionDiv = document.getElementById('providerDetection');
    const providerText = document.getElementById('providerText');
    
    if (provider) {
        currentProvider = provider;
        const providerInfo = emailProviders[provider];
        
        detectionDiv.classList.remove('d-none');
        providerText.innerHTML = `
            <strong>${providerInfo.name}</strong> detected - settings will be configured automatically
            <a href="${providerInfo.helpUrl}" target="_blank" class="ms-2">
                <i class="fas fa-external-link-alt"></i> Help
            </a>
        `;
        
        // Auto-fill server settings if not in advanced mode
        if (!document.getElementById('advancedMode').checked) {
            autoFillServerSettings(provider);
        }
    } else {
        currentProvider = null;
        detectionDiv.classList.add('d-none');
    }
}

function autoFillServerSettings(provider) {
    const providerInfo = emailProviders[provider];
    
    // Fill SMTP settings
    document.getElementById('smtpHost').value = providerInfo.smtp.host;
    document.getElementById('smtpPort').value = providerInfo.smtp.port;
    document.getElementById('smtpSsl').checked = providerInfo.smtp.ssl;
    
    // Fill IMAP settings
    document.getElementById('imapHost').value = providerInfo.imap.host;
    document.getElementById('imapPort').value = providerInfo.imap.port;
    document.getElementById('imapSsl').checked = providerInfo.imap.ssl;
}

function generateAccountName(email) {
    const nameField = document.getElementById('accountName');
    
    // Only auto-generate if field is empty
    if (nameField.value.trim() === '' && email.includes('@')) {
        const username = email.split('@')[0];
        const domain = email.split('@')[1];
        
        // Generate a friendly name
        let suggestedName = 'Primary';
        
        if (emailAccounts.length > 0) {
            suggestedName = username.charAt(0).toUpperCase() + username.slice(1);
        }
        
        // Ensure uniqueness
        let counter = 1;
        let finalName = suggestedName;
        while (emailAccounts.some(acc => acc.name.toLowerCase() === finalName.toLowerCase())) {
            finalName = `${suggestedName} ${counter}`;
            counter++;
        }
        
        nameField.value = finalName;
    }
}

function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + '-icon');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        field.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

function updateSSLCheckbox(type, port) {
    const sslCheckbox = document.getElementById(type + 'Ssl');
    
    // Auto-enable SSL for secure ports
    if (port == '465' || port == '993') {
        sslCheckbox.checked = true;
    } else if (port == '587' || port == '143') {
        sslCheckbox.checked = true; // TLS
    } else {
        sslCheckbox.checked = false;
    }
}

function showPasswordHelp() {
    const helpContent = `
        <div class="alert alert-info">
            <h6><i class="fas fa-info-circle me-2"></i>Email Password Setup</h6>
            <ul class="mb-0">
                <li><strong>Gmail:</strong> Use an App Password (requires 2FA enabled)</li>
                <li><strong>Outlook/Hotmail:</strong> Use an App Password</li>
                <li><strong>Zoho:</strong> Use your regular account password</li>
                <li><strong>Other:</strong> Check with your email provider</li>
            </ul>
        </div>
    `;
    
    showAlert(helpContent, 'info', false);
}

function addAccount() {
    const form = document.getElementById('addAccountForm');
    const submitBtn = form.querySelector('.btn-gradient');
    
    // Show loading state
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Adding Account...';
    submitBtn.disabled = true;
    
    const account = {
        name: document.getElementById('accountName').value.trim(),
        email: document.getElementById('accountEmail').value.trim(),
        password: document.getElementById('accountPassword').value,
        smtp_host: document.getElementById('smtpHost').value.trim() || null,
        smtp_port: parseInt(document.getElementById('smtpPort').value) || 465,
        smtp_use_ssl: document.getElementById('smtpSsl').checked,
        imap_host: document.getElementById('imapHost').value.trim() || null,
        imap_port: parseInt(document.getElementById('imapPort').value) || 993,
        imap_use_ssl: document.getElementById('imapSsl').checked,
        is_default: document.getElementById('isDefault').checked
    };

    // Enhanced validation
    const errors = [];
    
    if (!account.name) errors.push('Account name is required');
    if (!account.email) errors.push('Email address is required');
    if (!account.password) errors.push('Password is required');
    if (!account.email.includes('@')) errors.push('Invalid email address format');
    
    // Check for duplicate names and emails
    if (emailAccounts.some(acc => acc.name.toLowerCase() === account.name.toLowerCase())) {
        errors.push('An account with this name already exists');
    }
    if (emailAccounts.some(acc => acc.email.toLowerCase() === account.email.toLowerCase())) {
        errors.push('An account with this email already exists');
    }

    if (errors.length > 0) {
        showAlert('Please fix the following issues:<br>• ' + errors.join('<br>• '), 'danger', false);
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        return;
    }

    // Auto-detect settings if not in advanced mode
    if (!document.getElementById('advancedMode').checked && currentProvider) {
        const providerInfo = emailProviders[currentProvider];
        account.smtp_host = providerInfo.smtp.host;
        account.smtp_port = providerInfo.smtp.port;
        account.smtp_use_ssl = providerInfo.smtp.ssl;
        account.imap_host = providerInfo.imap.host;
        account.imap_port = providerInfo.imap.port;
        account.imap_use_ssl = providerInfo.imap.ssl;
    }

    // If this is the first account or explicitly set as default
    if (emailAccounts.length === 0 || account.is_default) {
        emailAccounts.forEach(acc => acc.is_default = false);
        account.is_default = true;
    }

    emailAccounts.push(account);
    updateStats();
    renderAccounts();
    
    // Reset form and close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('addAccountModal'));
    modal.hide();
    
    setTimeout(() => {
        form.reset();
        document.getElementById('providerDetection').classList.add('d-none');
        document.getElementById('advancedSettings').classList.add('d-none');
        document.getElementById('advancedMode').checked = false;
        currentProvider = null;
        
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }, 300);
    
    showAlert(`
        <strong>Account "${account.name}" added successfully!</strong><br>
        <small>Remember to save your configuration to apply changes.</small>
    `, 'success', false);
}

function editAccount(index) {
    const account = emailAccounts[index];
    
    document.getElementById('editAccountIndex').value = index;
    document.getElementById('editAccountName').value = account.name;
    document.getElementById('editAccountEmail').value = account.email;
    document.getElementById('editAccountPassword').value = account.password;
    document.getElementById('editSmtpHost').value = account.smtp_host || '';
    document.getElementById('editSmtpPort').value = account.smtp_port;
    document.getElementById('editSmtpSsl').checked = account.smtp_use_ssl;
    document.getElementById('editImapHost').value = account.imap_host || '';
    document.getElementById('editImapPort').value = account.imap_port;
    document.getElementById('editImapSsl').checked = account.imap_use_ssl;
    document.getElementById('editIsDefault').checked = account.is_default;
    
    const modal = new bootstrap.Modal(document.getElementById('editAccountModal'));
    modal.show();
}

function updateAccount() {
    const index = parseInt(document.getElementById('editAccountIndex').value);
    
    const account = {
        name: document.getElementById('editAccountName').value,
        email: document.getElementById('editAccountEmail').value,
        password: document.getElementById('editAccountPassword').value,
        smtp_host: document.getElementById('editSmtpHost').value || null,
        smtp_port: parseInt(document.getElementById('editSmtpPort').value) || 465,
        smtp_use_ssl: document.getElementById('editSmtpSsl').checked,
        imap_host: document.getElementById('editImapHost').value || null,
        imap_port: parseInt(document.getElementById('editImapPort').value) || 993,
        imap_use_ssl: document.getElementById('editImapSsl').checked,
        is_default: document.getElementById('editIsDefault').checked
    };

    if (account.is_default) {
        emailAccounts.forEach((acc, i) => {
            if (i !== index) acc.is_default = false;
        });
    }

    emailAccounts[index] = account;
    
    // Update stats and re-render
    updateStats();
    renderAccounts();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('editAccountModal'));
    modal.hide();
    
    showAlert(`
        <strong>Account "${account.name}" updated successfully!</strong><br>
        <small>Remember to save your configuration to apply changes permanently.</small>
    `, 'success', false);
}

function deleteAccount(index) {
    if (confirm('Are you sure you want to delete this account?')) {
        const account = emailAccounts[index];
        emailAccounts.splice(index, 1);
        
        if (account.is_default && emailAccounts.length > 0) {
            emailAccounts[0].is_default = true;
        }
        
        renderAccounts();
        showAlert('Account deleted successfully', 'success');
    }
}



function saveConfiguration() {
    if (emailAccounts.length === 0) {
        showAlert('Please add at least one email account', 'danger');
        return;
    }

    const hasDefault = emailAccounts.some(acc => acc.is_default);
    if (!hasDefault) {
        emailAccounts[0].is_default = true;
    }

    const configData = {
        accounts: emailAccounts
    };

    fetch('/api/email/config/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(configData)
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Configuration saved successfully! Please restart the application.', 'success');
            } else {
                showAlert('Error saving configuration: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error saving configuration:', error);
            showAlert('Error saving configuration', 'danger');
        });
}

function deleteAccount(index) {
    const account = emailAccounts[index];
    
    // Enhanced confirmation dialog
    const isDefault = account.is_default;
    const warningText = isDefault ? 
        `\n\nWARNING: This is your default account. If you delete it, another account will be set as default.` : '';
    
    if (confirm(`Are you sure you want to delete the account "${account.name}" (${account.email})?${warningText}`)) {
        emailAccounts.splice(index, 1);
        
        // If we deleted the default account, make the first remaining account default
        if (isDefault && emailAccounts.length > 0) {
            emailAccounts[0].is_default = true;
        }
        
        updateStats();
        renderAccounts();
        
        showAlert(`Account "${account.name}" deleted successfully`, 'success');
    }
}

function testConnection(accountName) {
    const testButton = event.target.closest('button') || event.target;
    const originalText = testButton.innerHTML;
    
    // Show loading state
    testButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Testing...';
    testButton.disabled = true;
    
    showAlert('Testing SMTP and IMAP connections...', 'info');
    
    fetch(`/api/email/accounts/${accountName}/test`, {
        method: 'POST'
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(`
                    <strong>✓ All tests passed for "${accountName}"!</strong><br>
                    <small>Both SMTP and IMAP connections are working. Account is ready for sending and reading emails.</small>
                `, 'success', false);
            } else {
                // Create detailed error message
                const details = data.details || {};
                let detailsHtml = '';
                
                if (details.smtp) {
                    const smtpIcon = details.smtp.success ? '✓' : '✗';
                    const smtpColor = details.smtp.success ? 'text-success' : 'text-danger';
                    detailsHtml += `<div class="${smtpColor}"><small><strong>${smtpIcon} SMTP:</strong> ${details.smtp.message}</small></div>`;
                }
                
                if (details.imap) {
                    const imapIcon = details.imap.success ? '✓' : '✗';
                    const imapColor = details.imap.success ? 'text-success' : 'text-danger';
                    detailsHtml += `<div class="${imapColor}"><small><strong>${imapIcon} IMAP:</strong> ${details.imap.message}</small></div>`;
                }
                
                showAlert(`
                    <strong>Connection test results for "${accountName}":</strong><br>
                    ${detailsHtml}
                    <div class="mt-2"><small class="text-muted">
                        ${details.smtp && details.smtp.success ? 'Email sending will work.' : 'Email sending may fail.'} 
                        ${details.imap && details.imap.success ? 'Email reading will work.' : 'Email reading will fail.'}
                    </small></div>
                `, 'warning', false);
            }
        })
        .catch(error => {
            console.error('Error testing connection:', error);
            showAlert('Connection test failed due to network error', 'danger');
        })
        .finally(() => {
            // Restore button state
            testButton.innerHTML = originalText;
            testButton.disabled = false;
        });
}

function saveConfiguration() {
    const saveButton = event.target;
    const originalText = saveButton.innerHTML;
    
    if (emailAccounts.length === 0) {
        showAlert('Please add at least one email account before saving', 'warning');
        return;
    }

    // Ensure at least one account is default
    const hasDefault = emailAccounts.some(acc => acc.is_default);
    if (!hasDefault && emailAccounts.length > 0) {
        emailAccounts[0].is_default = true;
    }

    // Show loading state
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
    saveButton.disabled = true;

    const configData = {
        accounts: emailAccounts
    };

    fetch('/api/email/config/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(configData)
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const storageType = data.storage_type || 'JSON file';
                const reloadMessage = data.config_reloaded ? 
                    'Configuration applied immediately!' : 
                    'Please restart the application to apply changes.';
                
                showAlert(`
                    <strong>Configuration saved successfully to ${storageType}!</strong><br>
                    <small>${reloadMessage} ${data.accounts_count} account(s) configured.</small>
                `, 'success', false);
                
                // If config was reloaded, refresh the page data
                if (data.config_reloaded) {
                    setTimeout(() => {
                        loadConfiguration();
                    }, 1000);
                }
            } else {
                showAlert(`Failed to save configuration: ${data.message}`, 'danger');
            }
        })
        .catch(error => {
            console.error('Error saving configuration:', error);
            showAlert('Failed to save configuration due to network error', 'danger');
        })
        .finally(() => {
            // Restore button state
            saveButton.innerHTML = originalText;
            saveButton.disabled = false;
        });
}

function showAlert(message, type, autoHide = true) {
    const alert = document.getElementById('configAlert');
    
    // Create enhanced alert content
    const alertContent = `
        <div class="d-flex align-items-start">
            <div class="flex-grow-1">
                ${message}
            </div>
            <button type="button" class="btn-close ms-3" onclick="hideAlert()"></button>
        </div>
    `;
    
    alert.className = `alert alert-${type} alert-dismissible`;
    alert.innerHTML = alertContent;
    alert.classList.remove('d-none');
    
    // Auto-hide after delay
    if (autoHide && (type === 'success' || type === 'info')) {
        setTimeout(() => {
            hideAlert();
        }, 5000);
    }
    
    // Scroll to top to show alert
    alert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function hideAlert() {
    const alert = document.getElementById('configAlert');
    alert.classList.add('d-none');
}

// Enhanced modal event listeners
document.addEventListener('DOMContentLoaded', function() {
    const addModal = document.getElementById('addAccountModal');
    
    addModal.addEventListener('shown.bs.modal', function() {
        // Focus on account name field when modal opens
        document.getElementById('accountName').focus();
    });
    
    addModal.addEventListener('hidden.bs.modal', function() {
        // Reset form when modal closes
        const form = document.getElementById('addAccountForm');
        form.reset();
        document.getElementById('providerDetection').classList.add('d-none');
        document.getElementById('advancedSettings').classList.add('d-none');
        document.getElementById('advancedMode').checked = false;
        currentProvider = null;
    });
});
</script>
{% endblock %} 